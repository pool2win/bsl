#lang errortrace racket/base

(require "environment.rkt"
         "bitcoin-environment.rkt"
         "eval-script.rkt")

(module+ test
  (require rackunit))


(module+ test
  (test-case
      "test bitcoin opcodes in bitcoin-environment"
    (let ([bitcoin-env (make-bitcoin-environment)])
      (let-values ([(script stack altstack verified) (apply-opcode 'op_false '() bitcoin-env '() '())])
        (check-equal? stack '(0)))
      (let-values ([(script stack altstack verified) (apply-opcode #x01 '(#"A") bitcoin-env '() '())])
        (check-equal? script '())
        (check-equal? stack  '(#"A")))
      (let-values ([(script stack altstack verified) (apply-opcode #x02 '(#"BC") bitcoin-env '() '())])
        (check-equal? script '())
        (check-equal? stack  '(#"BC")))
      (let-values ([(script stack altstack verified) (apply-opcode #x4c '(#x02 #"BC") bitcoin-env '() '())])
        (check-equal? script '())
        (check-equal? stack '(#"BC")))
      (let-values ([(script stack altstack verified) (apply-opcode #x4d '(#x0002 #"BC") bitcoin-env '() '())])
        (check-equal? script '())
        (check-equal? stack '(#"BC")))
      (let-values ([(script stack altstack verified) (apply-opcode #x4e '(#x000002 #"BC") bitcoin-env '() '())])
        (check-equal? script '())
        (check-equal? stack '(#"BC")))
      (let-values ([(script stack altstack verified) (apply-opcode #x4f '() bitcoin-env '(blah) '())])
        (check-equal? script '())
        (check-equal? stack '(-1 blah)))
      (let-values ([(script stack altstack verified) (apply-opcode #x51 '() bitcoin-env '(blah) '())])
        (check-equal? script '())
        (check-equal? stack '(1 blah)))
      (let-values ([(script stack altstack verified) (apply-opcode #x52 '() bitcoin-env '(blah) '())])
        (check-equal? script '())
        (check-equal? stack '(2 blah)))
      (let-values ([(script stack altstack verified) (apply-opcode #x60 '() bitcoin-env '(blah) '())])
        (check-equal? script '())
        (check-equal? stack '(16 blah)))
      (let-values ([(script stack altstack verified) (apply-opcode #x61 '() bitcoin-env '(blah) '())])
        (check-equal? script '())
        (check-equal? stack '(blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_if '((2 #"AA" 3 #"AAA") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_if '((2 #"AA" 3 #"AAA") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_if '((2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_if '((2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"BBB" #"BB" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_notif '((2 #"AA" 3 #"AAA") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_notif '((2 #"AA" 3 #"AAA") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_notif '((2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_notif '((2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"BBB" #"BB" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_if '((op_if (2 #"ZZ") op_endif) op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(1 1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"ZZ" blah)))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_verify '() bitcoin-env '(0) '())])
          (check-equal? verified #f))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_return '(#"AAA" #"BBB") bitcoin-env '(0) '())])
        (check-equal? stack '(0))
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #f))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_toaltstack '(#"AAA" #"BBB") bitcoin-env '(0) '())])
        (check-equal? stack '())
        (check-equal? altstack '(0))
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_fromaltstack '(#"AAA" #"BBB") bitcoin-env '(0) '(1))])
        (check-equal? stack '(1 0))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_ifdup '(#"AAA" #"BBB") bitcoin-env '(1) '())])
        (check-equal? stack '(1 1))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_ifdup '(#"AAA" #"BBB") bitcoin-env '(0 1) '())])
        (check-equal? stack '(0 1))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_depth '(#"AAA" #"BBB") bitcoin-env '(0 1) '())])
        (check-equal? stack '(2 0 1))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_drop '(#"AAA" #"BBB") bitcoin-env '(0 1) '())])
        (check-equal? stack '(1))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_drop '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_dup '(#"AAA" #"BBB") bitcoin-env '(0 1) '())])
        (check-equal? stack '(0 0 1))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_dup '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_nip '(#"AAA" #"BBB") bitcoin-env '(0 1) '())])
        (check-equal? stack '(0))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_nip '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_over '(#"AAA" #"BBB") bitcoin-env '(0 1 2 3) '())])
        (check-equal? stack '(1 0 2 3))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_over '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_pick '(#"AAA" #"BBB") bitcoin-env '(3 a b c d) '())])
        (check-equal? stack '(d a b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_pick '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_roll '(#"AAA" #"BBB") bitcoin-env '(2 a b c d) '())])
        (check-equal? stack '(c a b d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_roll '(#"AAA" #"BBB") bitcoin-env '(0 a b c d) '())])
        (check-equal? stack '(a b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_roll '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_rot '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(d a b c))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_rot '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_swap '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(b a c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_swap '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_tuck '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(a b a c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_tuck '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2drop '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2drop '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2dup '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(a b a b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2dup '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_3dup '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(a b c a b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_3dup '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2over '(#"AAA" #"BBB") bitcoin-env '(a b c d) '())])
        (check-equal? stack '(c d a b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2over '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2rot '(#"AAA" #"BBB") bitcoin-env '(a b c d e f g h) '())])
        (check-equal? stack '(e f a b c d g h))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2rot '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2swap '(#"AAA" #"BBB") bitcoin-env '(a b c d e f g h) '())])
        (check-equal? stack '(c d a b e f g h))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_2swap '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_size '(#"AAA" #"BBB") bitcoin-env '("abcd" x) '())])
        (check-equal? stack '(4 "abcd" x))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_size '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_equal '(#"AAA" #"BBB") bitcoin-env '(a a b c d) '())])
        (check-equal? stack '(#t b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_equal '(#"AAA" #"BBB") bitcoin-env '(a e b c d) '())])
        (check-equal? stack '(#f b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_equal '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_equalverify '(#"AAA" #"BBB") bitcoin-env '(a a b c d) '())])
        (check-equal? stack '(b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #t))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_equalverify '(#"AAA" #"BBB") bitcoin-env '(a e b c d) '())])
        (check-equal? stack '(b c d))
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #f))
      (let-values ([(script stack altstack verified) (apply-opcode 'op_equalverify '(#"AAA" #"BBB") bitcoin-env '() '())])
        (check-equal? stack '())
        (check-equal? altstack '())
        (check-equal? script '(#"AAA" #"BBB"))
        (check-equal? verified #f))
      ))

  (test-case
      "test eval-script in bitcoin-environment"
    (let ([bitcoin-env (make-bitcoin-environment)])
      (let-values ([(script env stack altstack)
                    (eval-script '(op_if (2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"BBB" #"BB" blah)))
      (let-values ([(script env stack altstack)
                    (eval-script '(op_if (2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script env stack altstack)
                    (eval-script '(op_notif (2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"BBB" #"BB" blah)))
      (let-values ([(script env stack altstack)
                    (eval-script '(op_notif (2 #"AA" 3 #"AAA") op_else (2 #"BB" 3 #"BBB") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script env stack altstack)
                    (eval-script '(op_if (2 #"AA" 3 #"AAA") op_endif) bitcoin-env '(1 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(#"AAA" #"AA" blah)))
      (let-values ([(script env stack altstack)
                    (eval-script '(op_if (2 #"AA" 3 #"AAA") op_endif) bitcoin-env '(0 blah) '())])
        (check-equal? script '())
        (check-equal? stack '(blah)))
      )))
